PREFIX="${PREFIX:-%%PREFIX%%}"

ENABLE_ZFS="${ENABLE_ZFS:-0}"
ZPOOL="${ZPOOL:-zroot}"
ZROOTFS="${ZROOTFS:-appjail}"
ZOPTS="${ZOPTS:--o compress=lz4}"

SHAREDIR="${SHAREDIR:-${PREFIX}/share/appjail}"
COMMANDS="${COMMANDS:-${SHAREDIR}/cmd}"
FILESDIR="${FILESDIR:-${SHAREDIR}/files}"
LIBDIR="${LIBDIR:-${SHAREDIR}/lib}"
SCRIPTSDIR="${SCRIPTSDIR:-${SHAREDIR}/scripts}"
UTILDIR="${UTILDIR:-${PREFIX}/libexec/appjail}"
MAKEJAILDIR="${MAKEJAILDIR:-${SHAREDIR}/makejail}"
MAKEJAIL_COMMANDS="${MAKEJAIL_COMMANDS:-${MAKEJAILDIR}/cmd}"
MAKEJAIL_WCOMMANDS="${MAKEJAIL_WCOMMANDS:-${MAKEJAILDIR}/write}"
DATADIR="${DATADIR:-${PREFIX}/appjail}"
CACHEDIR="${CACHEDIR:-${DATADIR}/cache}"
NETWORKDIR="${NETWORKDIR:-${DATADIR}/networks}"
RELEASEDIR="${RELEASEDIR:-${DATADIR}/releases}"
COMPONENTSDIR="${COMPONENTSDIR:-${CACHEDIR}/components}"
#APPJAIL_HOOKS=

LOGDIR="${LOGDIR:-/var/log/appjail}"
JAILDIR="${JAILDIR:-${DATADIR}/jails}"
TMPDIR="${TMPDIR:-${CACHEDIR}/tmp/.appjail}"
GLOBAL_GIT_CACHEDIR="${GLOBAL_GIT_CACHEDIR:-${CACHEDIR}/git}"

VOLUMESDIR="${VOLUMESDIR:-/volumes}"

AUTO_GIT_UPDATE="${AUTO_GIT_UPDATE:-1}"

AUTO_NETWORK_ADDR="${AUTO_NETWORK_ADDR:-10.0.0.0/10}"
AUTO_NETWORK_NAME="${AUTO_NETWORK_NAME:-ajnet}"
AUTO_NETWORK_DESC="${AUTO_NETWORK_DESC:-AppJail network}"

SHORTEN_DOMAIN_NAMES="${SHORTEN_DOMAIN_NAMES:-0}"
NETWORK_TO_SHORTEN="${NETWORK_TO_SHORTEN:-${AUTO_NETWORK_NAME}}"

DEFAULT_TEMPLATE="${DEFAULT_TEMPLATE:-${FILESDIR}/default_template.conf}"

#DEFAULT_TIMEZONE=
USE_TIMEZONE="${USE_TIMEZONE:-1}"

DEFAULT_BOOT="${DEFAULT_BOOT:-1}"

DEFAULT_PRIORITY="${DEFAULT_PRIORITY:-0}"

#DEFAULT_PACKAGES=

USE_PARALLEL="${USE_PARALLEL:-1}"
USE_PARALLEL_NATNET="${USE_PARALLEL_NATNET:-1}"

DEFAULT_DEVFS_RULESET="${DEFAULT_DEVFS_RULESET:-5}"
DEFAULT_MOUNT_DEVFS="${DEFAULT_MOUNT_DEVFS:-0}"
DEVFS_ASSIGN_ALGO="${DEVFS_ASSIGN_ALGO:-fsmn}"
DEVFS_FNFS="${DEVFS_FNFS:-1000}"

DEFAULT_START="${DEFAULT_START:-0}"
DEFAULT_RESTART="${DEFAULT_RESTART:-0}"
DEFAULT_RUN="${DEFAULT_RUN:-0}"
DEFAULT_LOGIN="${DEFAULT_LOGIN:-0}"
DEFAULT_LOGIN_USER="${DEFAULT_LOGIN_USER:-root}"

DEFAULT_COPYDIR="${DEFAULT_COPYDIR:-/}"

DEFAULT_OVERWRITE="${DEFAULT_OVERWRITE:-0}"

HOST_DOMAIN="${HOST_DOMAIN:-.appjail}"

USE_FIREWALL="${USE_FIREWALL:-pf}"
if [ -z "${EXT_IF}" ]; then
	# Get the external interface from the IPv4 routes.
	EXT_IF=`route -4 get default 2> /dev/null | grep 'interface:' | cut -d' ' -f4-`

	# If not, try to get the external interface from the IPv6 routes.
	if [ -z "${EXT_IF}" ]; then
		EXT_IF=`route -6 get default 2> /dev/null | grep 'interface:' | cut -d' ' -f4-`
	fi

	if [ -z "${EXT_IF}" ]; then
		echo "The external interface is not configured!" >&2
		exit 78 # EX_CONFIG
	fi
fi
ON_IF="${ON_IF:-${EXT_IF}}"
#EXT_IP=
SHARED_BRIDGE="${SHARED_BRIDGE:-appjail}"
DEFAULT_MTU="${DEFAULT_MTU:-1500}"
DEFAULT_VIRTUALNET_MTU="${DEFAULT_VIRTUALNET_MTU:-1500}"
DEFAULT_RESOLV_CONF="${DEFAULT_RESOLV_CONF:-/etc/resolv.conf}"
USE_RESOLV_CONF="${USE_RESOLV_CONF:-1}"

CREATED_FORMAT="${CREATED_FORMAT:-%Y-%m-%d %H:%M:%S}"
CONSOLELOG_NAME="${CONSOLELOG_NAME:-date +%Y-%m-%d.log}"
SESSION_ID_NAME="${SESSION_ID_NAME:-date +%Y-%m-%d.log}"
STARTUPLOG_NAME="${STARTUPLOG_NAME:-date +%Y-%m-%d.log}"
CONTAINERLOG_NAME="${CONTAINERLOG_NAME:-date +%Y-%m-%d.log}"
BUILDLOG_NAME="${BUILDLOG_NAME:-date +%Y-%m-%d_%Hh%Mm%Ss.log}"
ETCUPDATELOG_NAME="${ETCUPDATELOG_NAME:-date +%Y-%m-%d_%Hh%Mm%Ss.log}"

FREEBSD_UPDATE_CONF="${FREEBSD_UPDATE_CONF:-/etc/freebsd-update.conf}"

DEFAULT_FETCH_METHOD="${DEFAULT_FETCH_METHOD:-www}"
DEFAULT_INSTALL_METHOD="${DEFAULT_INSTALL_METHOD:-standard}"
DOWNLOADURL="${DOWNLOADURL:-https://download.freebsd.org/releases/%a/%v}"
COMPONENTS="${COMPONENTS:-base.txz}"
DEFAULT_RELEASE="${DEFAULT_RELEASE:-default}"
WWW_CMD="${WWW_CMD:-fetch -Rpm -o %o %u/%c}"

MAKEJAIL_FETCH_CMD="${MAKEJAIL_FETCH_CMD:-fetch -Rpm -o %o %u}"

MAKEJAIL_ADD_FETCH_CMD="${MAKEJAIL_ADD_FETCH_CMD:-fetch -Rpm -o - %u}"

if [ -z "${FREEBSD_ARCH}" ]; then
	FREEBSD_ARCH=`uname -m`
fi
if [ -z "${FREEBSD_VERSION}" ]; then
	FREEBSD_VERSION=`freebsd-version | grep -Eo '[0-9]+\.[0-9]+-[a-zA-Z0-9]+'`
fi

SRCDIR="${SRCDIR:-/usr/src}"
TARGET_ARCH="${TARGET_ARCH:-${FREEBSD_ARCH}}"
#MAKEARGS=
KERNEL="${KERNEL:-GENERIC}"
if [ -z "${JOBS}" ]; then
	JOBS=`sysctl -n hw.ncpu`
fi

IMAGESDIR="${IMAGESDIR:-${CACHEDIR}/images}"
IMAGE_COMPRESS="${IMAGE_COMPRESS:-xz}"
if [ -z "${IMAGE_ARCH}" ]; then
	IMAGE_ARCH=`uname -p`
fi
IMAGE_TAG="${IMAGE_TAG:-latest}"
IMAGE_FETCH_CMD="${IMAGE_FETCH_CMD:-fetch -Rpm -o %o %u}"
IMAGE_ENTRYPOINT="${IMAGE_ENTRYPOINT:-gh+AppJail-makejails}"
IMAGE_DOWNLOAD_METHOD="${IMAGE_DOWNLOAD_METHOD:-random}"

DEBOOTSTRAP_CMD="${DEBOOTSTRAP_CMD:-debootstrap --foreign --arch=%a --no-check-gpg %s %o}"
DEBOOTSTRAP_ARCH="${DEBOOTSTRAP_ARCH:-${FREEBSD_ARCH}}"
#DEBOOTSTRAP_MIRROR=
#DEBOOTSTRAP_SCRIPT=
APT_CACHE_START="${APT_CACHE_START:-251658240}"

ENABLE_DEBUG="${ENABLE_DEBUG:-1}"

ENABLE_COLORS="${ENABLE_COLORS:-1}"
ENABLE_RANDOM_COLORS="${ENABLE_RANDOM_COLORS:-1}"

ENABLE_LOGGING_OUTPUT="${ENABLE_LOGGING_OUTPUT:-0}"
SCRIPT_TIME="${SCRIPT_TIME:-30}"

RUNAS="${RUNAS:-doas}"

DEFAULT_HEALTH_TYPE="${DEFAULT_HEALTH_TYPE:-host}"
DEFAULT_RECOVER_TYPE="${DEFAULT_RECOVER_TYPE:-host}"
DEFAULT_HEALTH_CMD="${DEFAULT_HEALTH_CMD:-appjail status -q %j}"
DEFAULT_RECOVER_CMD="${DEFAULT_RECOVER_CMD:-appjail restart %j}"
DEFAULT_HEALTH_INTERVAL="${DEFAULT_HEALTH_INTERVAL:-30}"
DEFAULT_HEALTH_RETRIES="${DEFAULT_HEALTH_RETRIES:-3}"
DEFAULT_HEALTH_START_PERIOD="${DEFAULT_HEALTH_START_PERIOD:-0}"
DEFAULT_RECOVER_TOTAL="${DEFAULT_RECOVER_TOTAL:-3}"
DEFAULT_HEALTH_TIMEOUT="${DEFAULT_HEALTH_TIMEOUT:-120}"
DEFAULT_TIMEOUT_SIGNAL="${DEFAULT_TIMEOUT_SIGNAL:-sigterm}"
DEFAULT_TIMEOUT_KILL_AFTER="${DEFAULT_TIMEOUT_KILL_AFTER:-180}"
DEFAULT_RECOVER_TIMEOUT="${DEFAULT_RECOVER_TIMEOUT:-120}"
DEFAULT_RECOVER_TIMEOUT_SIGNAL="${DEFAULT_RECOVER_TIMEOUT_SIGNAL:-sigterm}"
DEFAULT_RECOVER_TIMEOUT_KILL_AFTER="${DEFAULT_RECOVER_TIMEOUT_KILL_AFTER:-180}"

DEFAULT_COLUMNS_VOLUME="${DEFAULT_COLUMNS_VOLUME:-name mountpoint type uid gid perm}"
DEFAULT_COLUMNS_LIMITS="${DEFAULT_COLUMNS_LIMITS:-nro enabled name rule loaded}"
DEFAULT_COLUMNS_STATS="${DEFAULT_COLUMNS_STATS:-maxproc cputime pcpu vmemoryuse readiops writeiops}"
DEFAULT_COLUMNS_LABEL="${DEFAULT_COLUMNS_LABEL:-name value}"
DEFAULT_COLUMNS_JAIL="${DEFAULT_COLUMNS_JAIL:-status name type version ports network_ip4}"
DEFAULT_COLUMNS_NETWORK="${DEFAULT_COLUMNS_NETWORK:-name network cidr broadcast gateway minaddr maxaddr addresses description mtu}"
DEFAULT_COLUMNS_IMAGE="${DEFAULT_COLUMNS_IMAGE:-name}"
DEFAULT_COLUMNS_NAT_JAIL="${DEFAULT_COLUMNS_NAT_JAIL:-name network rule}"
DEFAULT_COLUMNS_NAT_NETWORK="${DEFAULT_COLUMNS_NAT_NETWORK:-boot name rule}"
DEFAULT_COLUMNS_HEALTHCHECK="${DEFAULT_COLUMNS_HEALTHCHECK:-nro enabled name status health_type health_cmd recover_type recover_cmd}"
DEFAULT_COLUMNS_FSTAB="${DEFAULT_COLUMNS_FSTAB:-nro enabled name device mountpoint type options dump pass}"
DEFAULT_COLUMNS_DEVFS="${DEFAULT_COLUMNS_DEVFS:-nro enabled name rule}"
DEFAULT_COLUMNS_EXPOSE="${DEFAULT_COLUMNS_EXPOSE:-nro enabled name ports protocol network_name ext_if on_if}"

#BUILDAH_FROM_ARGS=

#TAR_ARGS=
TAR_COMPRESS_ARGS="${TAR_COMPRESS_ARGS:-${TAR_ARGS}}"
TAR_DECOMPRESS_ARGS="${TAR_DECOMPRESS_ARGS:-${TAR_ARGS}}"

TAR_BZIP_ARGS="${TAR_BZIP_ARGS:-${TAR_COMPRESS_ARGS} --bzip}"
TAR_GZIP_ARGS="${TAR_GZIP_ARGS:-${TAR_COMPRESS_ARGS} --gzip}"
TAR_LRZIP_ARGS="${TAR_LRZIP_ARGS:-${TAR_COMPRESS_ARGS} --lrzip}"
TAR_LZ4_ARGS="${TAR_LZ4_ARGS:-${TAR_COMPRESS_ARGS} --lz4}"
TAR_LZMA_ARGS="${TAR_LZMA_ARGS:-${TAR_COMPRESS_ARGS} --lzma}"
TAR_LZOP_ARGS="${TAR_LZOP_ARGS:-${TAR_COMPRESS_ARGS} --lzop}"
TAR_XZ_ARGS="${TAR_XZ_ARGS:-${TAR_COMPRESS_ARGS} --xz}"
TAR_ZSTD_ARGS="${TAR_ZSTD_ARGS:-${TAR_COMPRESS_ARGS} --zstd}"

#BZIP_ARGS=
BZIP_COMPRESS_ARGS="${BZIP_COMPRESS_ARGS:-${BZIP_ARGS}}"
BZIP_COMPRESS_CMD="${BZIP_COMPRESS_CMD:-bzip2 ${BZIP_COMPRESS_ARGS}}"
BZIP_DECOMPRESS_ARGS="${BZIP_DECOMPRESS_ARGS:-${BZIP_ARGS}}"
BZIP_DECOMPRESS_CMD="${BZIP_DECOMPRESS_CMD:-bzip2 ${BZIP_DECOMPRESS_ARGS} -d}"

#GZIP_ARGS=
GZIP_COMPRESS_ARGS="${GZIP_COMPRESS_ARGS:-${GZIP_ARGS}}"
GZIP_COMPRESS_CMD="${GZIP_COMPRESS_CMD:-gzip ${GZIP_COMPRESS_ARGS}}"
GZIP_DECOMPRESS_ARGS="${GZIP_DECOMPRESS_ARGS:-${GZIP_ARGS}}"
GZIP_DECOMPRESS_CMD="${GZIP_DECOMPRESS_CMD:-gzip -d ${GZIP_DECOMPRESS_ARGS}}"

#LRZIP_ARGS=
LRZIP_COMPRESS_ARGS="${LRZIP_COMPRESS_ARGS:-${LRZIP_ARGS}}"
LRZIP_COMPRESS_CMD="${LRZIP_COMPRESS_CMD:-lrzip ${LRZIP_COMPRESS_ARGS}}"
LRZIP_DECOMPRESS_ARGS="${LRZIP_DECOMPRESS_ARGS:-${LRZIP_ARGS}}"
LRZIP_DECOMPRESS_CMD="${LRZIP_DECOMPRESS_CMD:-lrzip -d ${LRZIP_DECOMPRESS_ARGS}}"

#LZ4_ARGS=
LZ4_COMPRESS_ARGS="${LZ4_COMPRESS_ARGS:-${LZ4_ARGS}}"
LZ4_COMPRESS_CMD="${LZ4_COMPRESS_CMD:-lz4 ${LZ4_COMPRESS_ARGS}}"
LZ4_DECOMPRESS_ARGS="${LZ4_DECOMPRESS_ARGS:-${LZ4_ARGS}}"
LZ4_DECOMPRESS_CMD="${LZ4_DECOMPRESS_CMD:-lz4 -d ${LZ4_DECOMPRESS_ARGS}}"

#LZMA_ARGS=
LZMA_COMPRESS_ARGS="${LZMA_COMPRESS_ARGS:-${LZMA_ARGS}}"
LZMA_COMPRESS_CMD="${LZMA_COMPRESS_CMD:-lzma ${LZMA_COMPRESS_ARGS}}"
LZMA_DECOMPRESS_ARGS="${LZMA_DECOMPRESS_ARGS:-${LZMA_ARGS}}"
LZMA_DECOMPRESS_CMD="${LZMA_DECOMPRESS_CMD:-lzma -d ${LZMA_DECOMPRESS_ARGS}}"

#LZOP_ARGS=
LZOP_COMPRESS_ARGS="${LZOP_COMPRESS_ARGS:-${LZOP_ARGS}}"
LZOP_COMPRESS_CMD="${LZOP_COMPRESS_CMD:-lzop ${LZOP_COMPRESS_ARGS}}"
LZOP_DECOMPRESS_ARGS="${LZOP_DECOMPRESS_ARGS:-${LZOP_ARGS}}"
LZOP_DECOMPRESS_CMD="${LZOP_DECOMPRESS_CMD:-lzop -d ${LZOP_DECOMPRESS_ARGS}}"

#XZ_ARGS=
XZ_COMPRESS_ARGS="${XZ_COMPRESS_ARGS:-${XZ_ARGS}}"
XZ_COMPRESS_CMD="${XZ_COMPRESS_CMD:-xz ${XZ_COMPRESS_ARGS}}"
XZ_DECOMPRESS_ARGS="${XZ_DECOMPRESS_ARGS:-${XZ_ARGS}}"
XZ_DECOMPRESS_CMD="${XZ_DECOMPRESS_CMD:-xz -d ${XZ_DECOMPRESS_ARGS}}"

#ZSTD_ARGS=
ZSTD_COMPRESS_ARGS="${ZSTD_COMPRESS_ARGS:-${ZSTD_ARGS}}"
ZSTD_COMPRESS_CMD="${ZSTD_COMPRESS_CMD:-zstd ${ZSTD_COMPRESS_ARGS}}"
ZSTD_DECOMPRESS_ARGS="${ZSTD_DECOMPRESS_ARGS:-${ZSTD_ARGS}}"
ZSTD_DECOMPRESS_CMD="${ZSTD_DECOMPRESS_CMD:-zstd -d ${ZSTD_DECOMPRESS_ARGS}}"

export SHELL=/bin/sh
